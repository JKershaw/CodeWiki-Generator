---
title: Environment-Aware Application Configuration
category: concept
sourceFile: server.js
related: [_history/_history/concepts/environment-aware-application-configuration/2025-11-24T14-38-57/2025-11-24T14-38-58.md, concepts/environment-aware-configuration.md]
created: 2025-11-24
updated: 2025-11-24
---

# [Environment-Aware Application Configuration](../_history/_history/concepts/environment-aware-application-configuration/2025-11-24T14-38-57/2025-11-24T14-38-58.md)

## Purpose and Overview

The `server.js` file establishes the [Express HTTP server infrastructure](../_history/components/express-http-server-infrastructure/2025-11-24T14-38-56.md) for the CodeWiki Dashboard and implements [environment-aware configuration](../concepts/environment-aware-configuration.md) that adapts application behavior based on deployment context (development, test, or production). This enables secure deployments, effective debugging during development, and reliable testability without compromising production safety.

## Key Functionality

### Express Application Setup
- Configures Express application with EJS view engine for server-side template rendering
- Serves static assets from the `/public` directory
- Initializes middleware stack for request processing, including body parsing and request validation

### Environment-Aware Behavior
The application responds differently based on the `NODE_ENV` environment variable:

- **Development/Test Mode**: Provides detailed error information in responses for debugging purposes
- **Production Mode**: Returns minimal error details to prevent information disclosure
- **Test Mode**: Disables automatic server startup for isolated unit testing

### Health Check Endpoint
The `/health` endpoint provides real-time server status information including:
- Current server status (operational/degraded)
- Server timestamp for synchronization verification
- Application version for compatibility checking

Used by monitoring systems and load balancers to verify server availability.

### Error Handling Pipeline
- **404 Handler**: Catches requests to undefined routes and returns structured JSON error responses
- **Global Error Handler**: Centralizes error logging and formatting, with environment-specific response granularity
- Ensures consistent error responses across all endpoints

### Graceful Shutdown
Implements SIGTERM signal handling to:
- Gracefully close the server when termination signals arrive
- Ensure proper resource cleanup before process exit
- Prevent abrupt terminations that can corrupt state in production environments

## Relationships

| Component | Relationship |
|-----------|-------------|
| **dotenv** | Loads environment variables for configuration management |
| **View Engine** | Uses EJS to render HTML templates from `/views` directory |
| **Static Files** | Serves public assets from `/public` directory |
| **Testing Framework** | Exports `app` and `server` instances for integration testing |
| **Monitoring Systems** | Exposes `/health` endpoint for uptime checks and load balancer probes |

## Usage Example

```javascript
// server.js - Basic startup pattern
const app = require('express')();
require('dotenv').config();

// Configure view engine
app.set('view engine', 'ejs');

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'operational', timestamp: new Date() });
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err);
  const detail = process.env.NODE_ENV === 'production' ? {} : { error: err.message };
  res.status(500).json({ success: false, ...detail });
});

// Start server (unless in test environment)
if (process.env.NODE_ENV !== 'test') {
  const server = app.listen(process.env.PORT || 3000);
  process.on('SIGTERM', () => server.close(() => process.exit(0)));
}

module.exports = app;
```

## Testing

**Test Coverage**: `tests/integration/server.test.js`
- **11 test cases** across **6 test suites**
- **Categories tested**:
  - Express Server initialization and startup behavior
  - Health Check endpoint responses and data format
  - Static file serving from `/public` directory
  - View engine configuration (EJS)
  - Error handling and middleware error responses
  - Middleware configuration and request processing pipeline

Tests verify environment-aware behavior including conditional startup logic and error response formatting based on `NODE_ENV` settings.