---
title: Flexible message formatting with JSON extraction
category: component
sourceFile: lib/claude.js
related: []
created: 2025-11-25
updated: 2025-11-25
---

# Flexible Message Formatting with JSON extraction

## Purpose and Overview

The flexible message formatting component provides dual-mode message handling for Claude API responses, supporting both plain text and structured JSON data extraction. It automatically parses JSON content from markdown code blocks in Claude's responses, enabling seamless handling of both conversational text and structured data outputs.

## Key Functionality

- **Dual Message Processing**: Handles both text-only responses via `sendMessage()` and JSON-structured responses via `sendMessageJSON()`
- **Automatic JSON Extraction**: Parses JSON content from markdown code blocks in Claude's responses using pattern matching
- **Format Flexibility**: Allows applications to choose the appropriate response format based on their needs
- **Graceful Fallback**: When JSON extraction fails, provides meaningful error handling while preserving the original response

The component works by sending messages through the standard Claude API and then post-processing responses to extract structured data when needed. For JSON responses, it searches for code blocks containing JSON and parses them into JavaScript objects.

## Relationships

This component is part of the broader ClaudeClient wrapper system and works alongside:
- **Anthropic SDK wrapper**: Uses the underlying API communication layer
- **Cost-aware API usage tracking**: Leverages the same token counting and cost calculation infrastructure  
- **Intelligent retry strategy**: Benefits from the retry mechanism for resilient JSON data extraction
- **Test-mode aware SDK initialization**: Supports mocking for testing JSON extraction logic

## Usage Example

```javascript
const ClaudeClient = require('./lib/claude.js');

// Initialize client
const claudeClient = new ClaudeClient();

// For plain text responses
const textResponse = await claudeClient.sendMessage('Explain quantum computing');

// For structured JSON responses
const jsonResponse = await claudeClient.sendMessageJSON('Generate a user profile in JSON format');
// Automatically extracts and parses JSON from Claude's markdown response
```

## Testing

**Test Coverage**: tests/unit/claude.test.js
- 29 test cases across 11 test suites
- Comprehensive testing of both `sendMessage` and `sendMessageJSON` methods
- JSON extraction logic validation and error handling scenarios
- Mock-based testing approach that isolates the formatting logic from API calls