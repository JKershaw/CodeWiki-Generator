---
title: Anthropic SDK wrapper with lazy loading
category: component
sourceFile: lib/claude.js
related: []
created: 2025-11-25
updated: 2025-11-25
---

# Anthropic SDK Wrapper with Lazy Loading

## Purpose and Overview

The ClaudeClient provides a streamlined interface to the Anthropic API with intelligent lazy loading to avoid SDK initialization during testing. It encapsulates message processing, cost tracking, and retry logic while maintaining flexibility for both text and structured JSON responses.

## Key Functionality

**Lazy SDK Initialization**
- Conditionally loads the Anthropic SDK only when needed, preventing API dependencies in test mode
- Automatically configures API key from application configuration

**Message Processing**
- `sendMessage()` - Sends text messages and returns plain text responses
- `sendMessageJSON()` - Sends messages and extracts JSON from markdown code blocks in responses
- Support for multiple Claude models including Haiku 4.5 and interleaved thinking modes
- Tool support for enhanced AI capabilities

**Cost Management**
- Tracks token usage (input/output) across all API calls
- Calculates costs based on model-specific pricing
- Provides cost summaries and reset capabilities via `getCostSummary()` and `resetCost()`
- Token estimation with `estimateTokens()` for budget planning

**Resilient Communication**
- Exponential backoff retry strategy for rate limits and transient errors
- Skips retries for authentication failures to avoid unnecessary delays
- Configurable retry attempts and delay intervals

## Relationships

- **Configuration System**: Retrieves API keys and test mode settings from application config
- **Test Framework**: Integrates with Jest mocking for comprehensive unit testing
- **Anthropic SDK**: Wraps the official Anthropic client library with enhanced functionality
- **Application Services**: Provides AI capabilities to other components requiring natural language processing

## Usage Example

```javascript
const ClaudeClient = require('./lib/claude');

// Initialize client (lazy loads Anthropic SDK)
const claudeClient = new ClaudeClient();

// Send text message
const response = await claudeClient.sendMessage('Explain quantum computing');

// Send message expecting JSON response
const jsonData = await claudeClient.sendMessageJSON('Generate a JSON summary of quantum computing concepts');

// Track costs
const costSummary = claudeClient.getCostSummary();
console.log(`Total cost: $${costSummary.totalCost}`);
```

## Testing

**Comprehensive Test Coverage**: 29 test cases across 11 test suites in `tests/unit/claude.test.js`

**Test Categories**:
- Constructor and initialization behavior
- Message sending (text and JSON variants)
- Token estimation and cost calculation
- Cost tracking and summary functionality
- Model-specific features (Haiku 4.5, interleaved thinking)
- Tool support integration
- Error handling and retry logic

**Mock Integration**: Tests use Jest mocks to simulate Anthropic API responses without incurring costs or external dependencies, validating the lazy loading pattern and ensuring reliable testing in CI/CD environments.