---
title: Category-aware concept extraction with backward compatibility
category: component
sourceFile: lib/agents/code-analysis-agent.js
related: [components/response-normalization-and-validation.md]
created: 2025-11-24
updated: 2025-11-24
---

# Category-aware Concept Extraction with Backward Compatibility

## Purpose and Overview

This component implements structured concept extraction with optional categorization while maintaining backward compatibility with legacy string-based formats. It enables the code analysis agent to represent concepts with rich metadata (category, abstraction level, reasoning) while seamlessly handling responses from older APIs that return concepts as simple strings.

## Key Functionality

The `_validateResponse` function handles [response normalization and validation](../components/response-normalization-and-validation.md):

- **Legacy Format Conversion**: Transforms legacy concept arrays (strings) into structured objects with metadata fields
- **Metadata Enrichment**: Adds category, abstraction level, and reasoning information to extracted concepts
- **Schema Validation**: Ensures consistent data structure across all response formats with sensible defaults for missing fields
- **Field Preservation**: Maintains critical fields like `filePath` and `sourceFile` from API responses
- **Guide Integration**: Appends `suggestedGuides` field to response schema for guide-based documentation

The validator guarantees that whether an API returns legacy string concepts or modern structured objects, the output maintains a uniform schema with all expected fields.

## Relationships

- **Extends**: Response validation layer to support enhanced concept metadata
- **Maintains**: Backward compatibility with existing code expecting string-based concept arrays
- **Integrates with**: Guide-based documentation system through `suggestedGuides` field
- **Used by**: Code analysis workflows that need to categorize and filter extracted concepts by type

## Usage Example

```javascript
const CodeAnalysisAgent = require('./lib/agents/code-analysis-agent');

const agent = new CodeAnalysisAgent();

// Normalized response with structured concept metadata
const mockResponse = {
  filePath: 'lib/dashboard-controller.js',
  concepts: [
    {
      name: 'DashboardController',
      category: 'component',
      abstraction: 'low',
      reason: 'Main controller for dashboard',
      sourceFile: 'lib/dashboard-controller.js'
    }
  ]
};

const validatedResponse = agent._validateResponse(mockResponse);
// Result maintains all metadata fields for concept routing and filtering
```

## Testing

Test coverage is comprehensive across three test suites:

- **10 test cases** covering core validation logic
- **3 test suites**: CodeAnalysisAgent, _validateResponse, isSignificantFile
- **Location**: `tests/unit/code-analysis-agent.test.js`

Tests verify that responses preserve file paths, handle concept metadata correctly, and maintain backward compatibility with legacy string-based formats.