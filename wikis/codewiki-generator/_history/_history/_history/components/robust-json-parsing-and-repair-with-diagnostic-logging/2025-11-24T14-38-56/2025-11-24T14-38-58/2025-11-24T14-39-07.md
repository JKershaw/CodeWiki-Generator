---
title: Robust JSON parsing and repair with diagnostic logging
category: component
sourceFile: lib/agents/guide-generation-agent.js
related: [components/defensive-filtering-of-malformed-data.md]
created: 2025-11-24
updated: 2025-11-24
---

# Robust JSON Parsing and Repair with Diagnostic Logging

## Purpose and Overview

This component implements a multi-layered error handling strategy for processing JSON responses from the Claude API within the Guide Generation Agent. It ensures that JSON parsing failures are handled systematically through repair attempts, validation, and graceful degradation rather than causing fatal failures that would halt the entire system.

## Key Functionality

The component provides the following error handling mechanisms:

### Empty Response Validation
Checks for null, undefined, or whitespace-only responses before attempting JSON parsing. Logs console warnings when empty responses are encountered, preventing unnecessary parsing attempts.

### JSON Repair and Validation
The `_cleanJSON` method is enhanced to:
- Attempt automatic repair of malformed JSON (e.g., removing trailing commas, fixing quote mismatches)
- Re-parse the repaired JSON to verify the repair was successful
- Throw contextual errors with diagnostic information if repair fails, preventing silent failures

### [Defensive Filtering of Malformed Data](../components/defensive-filtering-of-malformed-data.md)
Rather than rejecting entire API responses when individual guides are invalid:
- Validates each guide in the response array
- Filters out only the malformed items while preserving valid ones
- Logs warnings for invalid guides to maintain visibility of data quality issues
- Returns the filtered array of valid guides

### Comprehensive Diagnostic Logging
When JSON parsing fails, the component logs:
- Response length for context on payload size
- Preview samples (first and last 500 characters) to identify structural patterns
- Original error messages from the parser
- This information aids debugging of production issues without exposing full responses

## Relationships

- **GuideGenerationAgent Integration**: The error handling strategy directly supports the agent's integration with Claude API responses, ensuring robust processing of potentially malformed JSON.
- **Graceful Degradation Pattern**: When parsing or validation fails beyond repair, the component returns empty guide arrays as safe defaults, allowing dependent systems to continue operating rather than crashing.
- **Response Processing Pipeline**: JSON repair validation ensures the `_cleanJSON` method remains reliable throughout the agent's response processing workflow.

## Usage Example

No usage examples available from test code. Refer to the source implementation in `lib/agents/guide-generation-agent.js` for details on:
- Calling the empty response validation checks before parsing
- Using `_cleanJSON` for JSON repair with error handling
- Filtering guide arrays with validation logic
- Accessing diagnostic logs when parsing failures occur

## Testing

No automated test coverage is currently available for this component. Testing should verify:
- Empty/whitespace response handling
- JSON repair success and failure scenarios
- Individual guide validation and filtering behavior
- Diagnostic logging output for various failure modes