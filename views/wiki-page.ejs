<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - CodeWiki</title>
  <link rel="stylesheet" href="/public/style.css">
  <link rel="stylesheet" href="/public/comments.css">
</head>
<body>
  <div class="wiki-layout">
    <!-- Header with Search -->
    <header class="wiki-header">
      <div class="wiki-header-content">
        <div class="wiki-title-row">
          <h1 class="wiki-title"><%= title %></h1>
          <div class="wiki-actions">
            <button id="history-toggle-btn" class="btn btn-secondary">History</button>
            <a href="/wiki/<%= project %>/<%= page.path.replace('.md', '') %>/edit" class="btn btn-secondary btn-edit">Edit</a>
          </div>
        </div>

        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb">
          <a href="/">Dashboard</a>
          <span class="breadcrumb-separator">/</span>
          <a href="/wiki/<%= project %>/index">Wiki</a>
          <span class="breadcrumb-separator">/</span>
          <% if (page.metadata && page.metadata.category) { %>
            <a href="/wiki/<%= project %>/<%= page.metadata.category %>"><%= page.metadata.category %></a>
            <span class="breadcrumb-separator">/</span>
          <% } %>
          <span class="breadcrumb-current"><%= title %></span>
        </nav>

        <!-- Search Bar -->
        <div class="wiki-search-container">
          <form id="wiki-search-form" class="wiki-search-form">
            <input
              type="text"
              id="wiki-search-input"
              placeholder="Search wiki pages..."
              class="wiki-search-input"
            />
            <button type="submit" class="wiki-search-btn">Search</button>
          </form>
          <div id="search-results" class="search-results" style="display: none;"></div>
        </div>

        <!-- Metadata -->
        <% if (page.metadata) { %>
        <div class="wiki-metadata">
          <% if (page.metadata.category) { %>
            <span class="metadata-item">
              <strong>Category:</strong>
              <span class="category-badge"><%= page.metadata.category %></span>
            </span>
          <% } %>
          <% if (page.metadata.created) { %>
            <span class="metadata-item">
              <strong>Created:</strong> <%= page.metadata.created %>
            </span>
          <% } %>
          <% if (page.metadata.updated) { %>
            <span class="metadata-item">
              <strong>Updated:</strong> <%= page.metadata.updated %>
            </span>
          <% } %>
        </div>
        <% } %>

        <!-- Tags -->
        <% if (page.metadata && page.metadata.tags && page.metadata.tags.length > 0) { %>
        <div class="wiki-tags">
          <%
          const tags = Array.isArray(page.metadata.tags) ? page.metadata.tags : [page.metadata.tags];
          tags.forEach(tag => {
          %>
            <span class="tag-pill" data-tag="<%= tag %>"><%= tag %></span>
          <% }); %>
        </div>
        <% } %>
      </div>
    </header>

    <!-- Main Content Area with Sidebar -->
    <div class="wiki-content-wrapper">
      <!-- Sidebar -->
      <aside class="wiki-sidebar">
        <!-- Table of Contents -->
        <div class="sidebar-section toc-section">
          <h3 class="sidebar-title">On This Page</h3>
          <nav id="table-of-contents" class="toc-nav">
            <div class="toc-loading">Loading...</div>
          </nav>
        </div>

        <!-- Related Pages -->
        <div class="sidebar-section related-section">
          <h3 class="sidebar-title">Related Pages</h3>
          <div id="related-pages" class="related-pages-list">
            <div class="related-loading">Loading...</div>
          </div>
        </div>
      </aside>

      <!-- Main Article Content -->
      <main class="wiki-main">
        <article class="wiki-content">
          <%- page.content %>
        </article>

        <!-- History Panel (Hidden by default) -->
        <section id="history-panel" class="history-panel" style="display: none;">
          <div class="history-header">
            <h2 class="history-title">Page History</h2>
            <button id="history-close-btn" class="btn btn-sm">Close</button>
          </div>

          <div id="history-content" class="history-content">
            <div class="history-loading">Loading history...</div>
          </div>

          <!-- History Timeline -->
          <div id="history-timeline" class="history-timeline" style="display: none;">
            <!-- Timeline items will be inserted here by JavaScript -->
          </div>

          <!-- No Git Repository Message -->
          <div id="no-git-message" class="no-git-message" style="display: none;">
            <p>No git repository found for this project.</p>
            <p>Git history is not available.</p>
          </div>
        </section>

        <!-- Comments Section -->
        <section id="comments-section" class="comments-section">
          <h2 class="comments-title">Comments</h2>

          <!-- Add Comment Form -->
          <div class="comment-form-container">
            <form id="add-comment-form" class="comment-form">
              <div class="form-group">
                <label for="comment-author">Your Name:</label>
                <input
                  type="text"
                  id="comment-author"
                  name="author"
                  placeholder="Anonymous"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label for="comment-content">Comment:</label>
                <textarea
                  id="comment-content"
                  name="content"
                  rows="4"
                  placeholder="Share your thoughts, questions, or feedback..."
                  class="form-textarea"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Add Comment</button>
            </form>
          </div>

          <!-- Comments List -->
          <div id="comments-list" class="comments-list">
            <div class="comments-loading">Loading comments...</div>
          </div>
        </section>

        <!-- Back to Top Button -->
        <button id="back-to-top" class="back-to-top" style="display: none;">
          ↑ Top
        </button>
      </main>
    </div>

    <!-- Footer -->
    <footer class="wiki-footer">
      <a href="/">← Back to Dashboard</a>
      <span class="footer-separator">|</span>
      <a href="/wiki/<%= project %>/index">← Back to Wiki Index</a>
    </footer>
  </div>

  <!-- Pass data to JavaScript -->
  <script>
    window.wikiData = {
      project: '<%= project %>',
      pagePath: '<%= page.path %>',
      title: '<%= title %>'
    };
  </script>
  <script src="/public/wiki-browser.js"></script>
  <script src="/public/comments.js"></script>
  <script src="/public/git-history.js"></script>
</body>
</html>
